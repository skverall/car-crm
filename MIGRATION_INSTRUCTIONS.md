# Инструкции по исправлению проблем с добавлением записей

## Проблема
Записи не добавляются в разделы:
- Debts (Долги)
- General Expenses (Общие расходы)
- Customers (Клиенты)

## Причина
Таблицы в базе данных используют неправильные RLS (Row Level Security) политики и не имеют поля `user_id` для изоляции данных пользователей.

## Решение

### Шаг 1: Выполнить миграцию в Supabase

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Войдите в свой проект
3. Перейдите в **SQL Editor** (в левом меню)
4. **ИСПОЛЬЗУЙТЕ БЕЗОПАСНУЮ ВЕРСИЮ:** Скопируйте и выполните весь SQL код из файла `supabase/migrations/20241225_safe_user_isolation.sql`

**ВАЖНО:**
- Используйте файл `20241225_safe_user_isolation.sql` - он безопаснее обрабатывает внешние ключи
- Выполните весь файл миграции полностью
- Если возникают ошибки, остановитесь и сообщите о них

### Шаг 2: Проверить результат

После выполнения миграции:

1. **Debts (Долги)** - должны добавляться корректно
2. **General Expenses (Общие расходы)** - должны добавляться корректно  
3. **Customers (Клиенты)** - должны добавляться корректно

### Что делает миграция

1. **Добавляет поле `user_id`** во все таблицы:
   - `debts`
   - `expenses` 
   - `clients`
   - `documents`

2. **Обновляет существующие записи** - привязывает их к пользователям на основе связей с автомобилями

3. **Удаляет неправильные RLS политики** - убирает `auth.role() = 'authenticated'`

4. **Создает правильные RLS политики** - использует `auth.uid() = user_id`

5. **Добавляет индексы** для улучшения производительности

### Изменения в коде приложения

Код приложения уже обновлен для работы с новой структурой:

- ✅ `AddDebtModal.tsx` - добавляет `user_id` при создании долгов
- ✅ `AddExpenseModalAdvanced.tsx` - добавляет `user_id` при создании расходов
- ✅ `AddExpenseModal.tsx` - добавляет `user_id` при создании расходов
- ✅ `CustomersPage.tsx` - добавляет `user_id` при создании клиентов
- ✅ `ClientsModal.tsx` - добавляет `user_id` при создании клиентов
- ✅ `FinancePage.tsx` - фильтрует по `user_id`
- ✅ `DebtsPage.tsx` - фильтрует по `user_id`
- ✅ `ExpenseDetailModal.tsx` - проверяет владельца по `user_id`
- ✅ Типы TypeScript обновлены

### Примечания

- **Существующие данные**: Записи без связи с автомобилями будут удалены
- **Изоляция пользователей**: Каждый пользователь будет видеть только свои данные
- **Безопасность**: RLS политики обеспечивают защиту на уровне базы данных

### Если что-то не работает

1. Проверьте, что миграция выполнена полностью
2. Обновите страницу в браузере
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь, что пользователь аутентифицирован
